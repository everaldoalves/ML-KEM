#include <stdio.h>
#include <locale.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include "amostragem.h"
#include "auxiliares.h"
#include "ntt.h"
#include "parametros.h"
#include "pkeKeyGen.h"
#include "fips202.h"
#include <openssl/sha.h>
#include <openssl/evp.h>

/*******************************************************************
Algoritmo 12 - KeyGen() -  ML-KEM FIPS 203 ipd
Generates an encryption key and a corresponding decryption key.
Output: encryption key ekPKE ∈ B^384k+32.
Output: decryption key dkPKE ∈ B^384k. 
********************************************************************/

void calculaT_hat(const uint16_t A[KYBER_K][KYBER_K][KYBER_N], const uint16_t s[KYBER_K][KYBER_N], const uint16_t e[KYBER_K][KYBER_N], uint16_t t_hat[KYBER_K][KYBER_N]) {
    uint16_t tempResultado[KYBER_K][KYBER_N] = {{0}};

    for (int i = 0; i < KYBER_K; ++i) {
        for (int k = 0; k < KYBER_K; ++k) {
            uint16_t tempMultiplicacao[KYBER_N] = {0}; 
            multiplicaNTT(A[i][k], s[k], tempMultiplicacao); 

            // Adiciona tempMultiplicacao ao tempResultado[i], com redução modular
            for (int n = 0; n < KYBER_N; ++n) {
                tempResultado[i][n] = (tempResultado[i][n] + tempMultiplicacao[n]) % KYBER_Q;
            }
        }
    }

    // Adiciona "e" a tempResultado para obter t_hat com redução modular
    for (int i = 0; i < KYBER_K; ++i) {
        for (int n = 0; n < KYBER_N; ++n) {
            t_hat[i][n] = (tempResultado[i][n] + e[i][n]) % KYBER_Q;
        }
    }
}

void exibeVetorPolinomios(uint16_t vetor[2][256], char* nomeVetor){
    printf("\n Vetor %s : ", nomeVetor);
    for (int i = 0; i < KYBER_K; i++)
    {
        for (int j = 0; j < KYBER_N; j++)
        {
            printf("%d ,",vetor[i][j]);
        }
        printf("\n");
    }
    
}

void verificaCalculoT(uint16_t t1[2][256],uint16_t t2[2][256]) {
     if((memcmp(t1[0],t2[0],sizeof(t1[0]))==0) && (memcmp(t1[1],t2[1],sizeof(t1[1]))==0)) {
        printf("\n\n Vetor t foi calculado corretamente!!!!");
    }
    else {
        printf("\n\n Falha no cálculo do vetor t");
    }
}

void exibeChaves(chavesPKE chaves) {
    printf("Chaves \n chave pública : ");
    for (int i = 0; i < sizeof(chaves.ek)/sizeof(chaves.ek[0]); i++)
    {
        printf("%02x", chaves.ek[i]);
    }
    printf("\n \nchave privada : ");
    for (int i = 0; i < sizeof(chaves.dk)/sizeof(chaves.dk[0]); i++)
    {
        printf("%02x", chaves.dk[i]);
    }
}

chavesPKE pkeKeyGen() {
    
    unsigned char d[32];                          // Array para armazenar os 32 bytes aleatórios  
    unsigned char rho[32], sigma[32];            // saídas de G
    chavesPKE chaves = {0};   
    unsigned char output[64 * KYBER_ETA1] = {0};    // Bytes aleatórios para SamplePolyCBD

    uint8_t N = 0;        
    uint16_t f[KYBER_N] = {0};

    uint16_t A[KYBER_K][KYBER_K][KYBER_N] = {
    {
        {448, 2251, 1964, 3149, 470, 2648, 2455, 3294, 2477, 1301, 2675, 924, 982, 2299, 2681, 3138, 1176, 120, 1760, 1557, 1563, 1805, 1565, 2827, 1800, 1997, 2913, 1336, 657, 851, 3125, 2725, 2462, 171, 1047, 2681, 2484, 1027, 1832, 2122, 2169, 1250, 777, 342, 2995, 1280, 188, 2435, 116, 2389, 2443, 266, 312, 1587, 1246, 2583, 564, 1759, 179, 2347, 175, 2751, 1486, 823, 2854, 1860, 1770, 781, 2618, 1943, 2073, 425, 3009, 1654, 128, 127, 1376, 2761, 3281, 662, 1773, 3279, 778, 2720, 165, 533, 182, 751, 1183, 1915, 2885, 1207, 517, 3019, 1012, 2963, 3265, 2304, 3162, 1528, 2085, 956, 2713, 924, 2310, 2743, 1390, 1224, 2246, 2285, 1748, 411, 2987, 1314, 1346, 3301, 1822, 1967, 1097, 1269, 1415, 123, 3046, 871, 2780, 2288, 2353, 2243, 1342, 140, 1165, 1322, 1101, 135, 3031, 443, 1183, 1593, 1295, 500, 2482, 1873, 1524, 2642, 458, 2411, 2293, 3183, 3260, 155, 1989, 980, 1053, 1670, 1941, 3032, 2514, 1158, 168, 648, 956, 197, 2105, 272, 477, 3036, 1916, 2439, 112, 1311, 2876, 1815, 1953, 513, 2964, 1146, 1246, 289, 2403, 2507, 1031, 1816, 2779, 424, 135, 349, 2137, 1216, 1536, 116, 2528, 974, 1852, 266, 306, 2788, 57, 553, 2413, 1081, 3165, 804, 196, 2364, 161, 1732, 2019, 2525, 2680, 1564, 2285, 340, 1205, 3046, 396, 3192, 1515, 1849, 460, 3243, 580, 2282, 9, 2519, 97, 1578, 3255, 691, 855, 2457, 41, 908, 2257, 1078, 2525, 2558, 2229, 2899, 2125, 1551, 2747, 1186, 1231, 3216, 2801, 1292, 2300, 3276, 1615, 2745, 3198, 2971, 1674, 2490, 569, 994}, 
        {1860, 2390, 2550, 1426, 3169, 1605, 819, 789, 1949, 2067, 2580, 2141, 345, 1848, 2503, 1307, 2679, 729, 1075, 1116, 1320, 2699, 1927, 779, 966, 318, 489, 3107, 1094, 2263, 3024, 1369, 1977, 164, 512, 736, 1953, 858, 764, 2298, 1760, 1079, 3310, 1623, 79, 358, 1480, 272, 138, 1640, 1707, 2305, 475, 2422, 2414, 635, 2867, 1854, 2349, 2235, 2610, 2915, 1714, 3186, 1560, 2318, 2007, 973, 1786, 1779, 1314, 2059, 1646, 1176, 2219, 3285, 1781, 462, 1222, 533, 1004, 2456, 161, 1756, 2104, 2299, 1488, 2074, 459, 1088, 2168, 540, 1194, 2811, 2916, 2367, 1534, 929, 163, 799, 2971, 156, 2650, 1257, 2007, 1421, 1249, 377, 1604, 912, 1379, 3282, 1862, 1477, 1315, 2148, 2262, 1700, 2118, 1470, 2509, 29, 160, 22, 1772, 1252, 800, 1243, 1394, 2226, 94, 426, 2003, 2481, 2191, 2825, 1968, 1912, 3076, 30, 613, 194, 2691, 2236, 436, 2876, 3190, 2847, 2476, 2395, 1526, 253, 1089, 2053, 2174, 2708, 118, 1915, 1560, 591, 683, 2468, 1878, 3281, 2384, 2823, 1617, 969, 2552, 482, 2227, 443, 1435, 3064, 2732, 394, 2348, 2127, 372, 1936, 2318, 3262, 2116, 819, 2740, 2832, 1952, 765, 2136, 641, 136, 2376, 383, 2824, 718, 191, 1047, 3030, 1939, 463, 3264, 2009, 209, 3123, 2128, 1132, 802, 1570, 2123, 2617, 2599, 1561, 1754, 2145, 358, 1256, 2566, 62, 1777, 2933, 2273, 378, 3138, 2085, 1066, 3021, 53, 2072, 1840, 2752, 2138, 1432, 434, 451, 1277, 805, 1934, 2381, 1873, 470, 482, 2416, 882, 2336, 1270, 2826, 2293, 2075, 2293, 735, 2480, 1909, 2018, 1088, 1512, 1551}
    }, 
    {
        {2306, 2675, 3311, 2283, 1272, 2927, 2219, 2611, 1808, 1595, 71, 533, 1671, 2960, 2112, 2296, 2356, 1866, 61, 1675, 1997, 2215, 667, 1629, 944, 2727, 2969, 2010, 2901, 1787, 1287, 2042, 1487, 3130, 435, 2084, 2912, 1714, 539, 1119, 2990, 1399, 3097, 1359, 1393, 798, 2132, 1980, 3291, 1157, 2741, 2483, 1117, 2954, 1471, 1344, 2560, 2772, 1047, 2455, 1736, 141, 32, 3160, 1112, 660, 6, 2703, 2038, 27, 2254, 1108, 218, 2812, 1972, 1806, 1843, 1724, 918, 3031, 998, 1402, 2066, 1145, 1132, 2327, 2070, 1212, 3116, 3240, 2896, 766, 1842, 1442, 1053, 1812, 151, 2548, 510, 3126, 1207, 3310, 86, 2737, 184, 3170, 1560, 1974, 2690, 275, 2211, 2655, 510, 2922, 2136, 935, 1511, 793, 550, 2498, 2328, 2245, 266, 218, 1888, 1369, 536, 1319, 1595, 2371, 2941, 2642, 1249, 1560, 1268, 2847, 915, 1310, 884, 1990, 1128, 1408, 51, 983, 3226, 2723, 1446, 572, 1714, 849, 2100, 2504, 24, 2738, 2532, 147, 1829, 1847, 2649, 1552, 376, 3146, 1389, 2056, 2380, 1103, 568, 3227, 1388, 2812, 2139, 2154, 1723, 964, 2601, 709, 1035, 259, 3079, 1983, 468, 110, 3141, 2777, 694, 151, 2736, 2461, 2065, 3289, 234, 1321, 971, 1628, 565, 2375, 997, 1144, 1321, 2109, 2414, 788, 1791, 1017, 2080, 115, 185, 763, 2407, 2151, 844, 229, 1158, 898, 636, 851, 606, 1475, 2807, 572, 2802, 2388, 922, 350, 2386, 1691, 1561, 1791, 902, 1034, 2266, 2759, 692, 107, 2681, 1890, 3079, 1604, 1680, 1383, 484, 202, 1218, 491, 1249, 2334, 488, 747, 2299, 2409, 2342, 1498, 434, 1295, 2387, 2022}, 
        {3271, 1399, 251, 1330, 3107, 1425, 253, 2875, 114, 2638, 1480, 843, 19, 355, 1329, 375, 1035, 2247, 1737, 3169, 3208, 44, 3180, 2830, 2664, 1794, 2888, 2482, 1875, 762, 3186, 2607, 823, 584, 498, 2149, 640, 3242, 283, 3182, 483, 2581, 1974, 2080, 2457, 731, 2139, 129, 342, 1680, 1665, 975, 3328, 1576, 1474, 2119, 2141, 1083, 2854, 71, 2629, 1133, 1475, 2066, 1760, 706, 1601, 1825, 411, 704, 547, 1028, 1742, 1808, 2067, 1527, 1435, 1139, 1364, 2097, 1218, 53, 166, 382, 1392, 2424, 289, 2925, 2876, 2000, 2069, 2742, 947, 1398, 2058, 1198, 2879, 1119, 1532, 1234, 3219, 972, 1307, 513, 2071, 781, 2865, 175, 273, 1604, 2335, 975, 2120, 2175, 79, 1689, 3137, 2142, 2633, 1619, 2238, 2325, 1572, 442, 3008, 1510, 1468, 796, 1614, 1885, 2503, 2876, 767, 203, 2103, 512, 2765, 2372, 3122, 984, 857, 1791, 2521, 2717, 749, 2332, 1564, 69, 584, 2173, 686, 754, 1155, 2558, 775, 1579, 45, 622, 2505, 2270, 3033, 723, 2762, 269, 2858, 782, 1561, 809, 2306, 2375, 2988, 3253, 1276, 1774, 3129, 1614, 3294, 1229, 2296, 2191, 480, 150, 1001, 452, 209, 1421, 2082, 89, 1731, 685, 1272, 2725, 422, 811, 2381, 1724, 528, 1260, 858, 1247, 272, 1435, 467, 1921, 1120, 2463, 2770, 2750, 1654, 3223, 2262, 2808, 140, 1730, 106, 1640, 2617, 1192, 608, 1938, 1964, 17, 174, 1249, 2881, 65, 1431, 1801, 2291, 314, 113, 174, 2717, 2404, 3105, 1211, 1919, 3227, 609, 2340, 854, 703, 99, 359, 123, 1293, 458, 850, 582, 1604, 1616, 2576, 2706, 2987, 1409, 361}
    }
    };

    uint16_t s[KYBER_K][KYBER_N] = {
        {0, 3328, 0, 0, 1, 3327, 0, 0, 0, 0, 0, 3328, 2, 3327, 3327, 0, 1, 1, 3328, 1, 3327, 0, 0, 0, 0, 3328, 0, 3328, 0, 3327, 0, 3, 0, 3328, 3328, 3327, 0, 3328, 3328, 3327, 3326, 1, 2, 1, 0, 2, 3328, 0, 3328, 0, 1, 0, 2, 2, 3328, 2, 3328, 2, 3328, 0, 0, 3328, 1, 1, 0, 1, 0, 3328, 0, 0, 2, 1, 1, 0, 3328, 0, 2, 2, 1, 1, 0, 0, 2, 0, 3328, 3327, 3327, 3328, 3327, 2, 3328, 0, 0, 3328, 0, 1, 0, 1, 0, 0, 3327, 3328, 0, 3, 1, 3328, 0, 0, 0, 0, 3327, 3328, 0, 3328, 3328, 3328, 3327, 0, 0, 0, 1, 0, 0, 0, 3328, 3327, 0, 1, 1, 1, 0, 0, 0, 3328, 3327, 3326, 3328, 1, 3327, 3328, 3328, 0, 3328, 0, 3, 3328, 1, 0, 1, 3327, 3328, 0, 3328, 1, 1, 3, 0, 3328, 2, 3328, 1, 0, 2, 2, 1, 1, 3328, 3, 3327, 1, 0, 1, 0, 1, 0, 0, 1, 0, 0, 3328, 0, 3328, 1, 0, 2, 0, 2, 2, 0, 2, 2, 1, 0, 0, 3328, 2, 3328, 1, 1, 3328, 1, 0, 0, 3328, 1, 0, 3328, 0, 0, 0, 1, 3328, 2, 0, 1, 1, 3328, 3328, 0, 0, 3328, 1, 3328, 0, 3327, 0, 3328, 0, 0, 1, 2, 3327, 3328, 1, 0, 3328, 3326, 3327, 0, 2, 1, 0, 3328, 3327, 0, 1, 0, 3328, 1, 1, 0, 1, 1, 1, 0, 1},
        {1, 3327, 1, 0, 3328, 3327, 0, 1, 3327, 0, 1, 0, 3327, 0, 0, 2, 3327, 0, 1, 3328, 1, 1, 0, 2, 3328, 3328, 3328, 2, 3328, 1, 1, 3327, 0, 3, 2, 0, 0, 3328, 0, 2, 0, 0, 1, 1, 3327, 2, 0, 3328, 3326, 0, 1, 3327, 3328, 2, 0, 1, 3, 3327, 1, 2, 0, 3328, 3327, 3327, 0, 1, 3327, 0, 0, 3328, 0, 0, 0, 1, 0, 2, 3328, 0, 0, 3328, 3327, 2, 2, 0, 0, 3327, 0, 0, 0, 1, 0, 3327, 1, 1, 3328, 1, 3328, 0, 1, 0, 3327, 0, 1, 3326, 0, 0, 0, 3328, 1, 0, 3327, 2, 1, 0, 3328, 3328, 0, 3328, 3328, 3328, 1, 0, 3328, 3328, 3328, 0, 1, 3328, 3328, 3328, 1, 1, 0, 3328, 3328, 0, 2, 1, 3328, 3328, 0, 0, 1, 0, 3328, 3328, 1, 0, 1, 0, 1, 1, 3328, 2, 0, 3327, 1, 3328, 1, 0, 1, 2, 1, 0, 0, 0, 1, 0, 1, 1, 2, 0, 3327, 3328, 1, 1, 1, 3327, 0, 3328, 1, 3328, 1, 2, 1, 3328, 0, 3328, 3328, 3327, 1, 3327, 0, 3326, 3327, 2, 0, 3327, 0, 2, 3327, 0, 3328, 1, 0, 1, 0, 0, 3327, 3328, 1, 1, 1, 1, 1, 0, 3328, 0, 2, 1, 3327, 3327, 3327, 0, 2, 2, 0, 1, 0, 0, 2, 0, 1, 1, 2, 0, 1, 3327, 0, 3327, 1, 1, 3328, 3326, 0, 1, 0, 1, 0, 0, 2, 3328, 1, 2, 0, 1}
        };

    uint16_t e[KYBER_K][KYBER_N] = {
        {3328, 3328, 0, 1, 3328, 0, 1, 0, 3328, 0, 3328, 3328, 3328, 3326, 2, 3328, 3328, 2, 1, 0, 2, 3326, 0, 0, 0, 0, 0, 0, 1, 3328, 3328, 2, 3328, 3328, 3328, 1, 3327, 0, 0, 3, 3327, 1, 0, 1, 1, 0, 3327, 0, 0, 2, 0, 1, 0, 3328, 3328, 1, 3, 1, 3328, 3328, 0, 3327, 3327, 3328, 1, 0, 0, 0, 0, 0, 2, 0, 3328, 2, 0, 1, 1, 3328, 0, 3328, 3327, 1, 0, 1, 3328, 1, 2, 1, 1, 0, 3328, 0, 0, 1, 0, 0, 0, 2, 0, 1, 0, 1, 3328, 1, 3328, 0, 3327, 0, 1, 3328, 3328, 1, 3328, 2, 0, 3327, 3328, 0, 0, 0, 3328, 2, 0, 3327, 0, 0, 1, 0, 3328, 1, 3328, 1, 0, 0, 1, 3328, 3328, 1, 1, 3328, 0, 1, 3328, 1, 1, 3327, 3328, 3328, 2, 1, 1, 2, 3328, 0, 1, 3328, 0, 2, 1, 0, 0, 3328, 1, 0, 1, 3328, 3328, 3328, 1, 3328, 1, 0, 0, 3328, 1, 1, 1, 0, 1, 0, 3327, 0, 2, 3328, 0, 1, 0, 3, 0, 3, 0, 3328, 2, 3328, 2, 0, 2, 3328, 0, 0, 0, 0, 1, 3327, 0, 0, 0, 3, 3327, 0, 1, 0, 2, 3328, 0, 2, 3328, 0, 0, 3328, 2, 0, 3328, 0, 1, 0, 0, 0, 3328, 3328, 3328, 1, 0, 3327, 3326, 0, 2, 0, 0, 0, 1, 0, 3328, 3327, 2, 2, 0, 0, 3326, 0, 3327, 3328, 0, 1, 2, 3328},
        {0, 1, 3328, 3328, 0, 3328, 1, 3328, 1, 1, 0, 3327, 0, 3328, 2, 3328, 1, 2, 3, 2, 2, 3327, 3327, 1, 2, 0, 3328, 0, 0, 3327, 1, 2, 1, 0, 0, 2, 2, 0, 3328, 0, 0, 0, 1, 0, 2, 1, 3328, 1, 2, 1, 0, 0, 3328, 3328, 3328, 3328, 1, 3328, 3327, 1, 3328, 1, 3328, 0, 0, 3327, 3328, 3, 1, 0, 3328, 2, 1, 0, 0, 0, 0, 3328, 3328, 0, 1, 3327, 3327, 1, 3328, 1, 3328, 3328, 0, 3328, 0, 2, 1, 0, 0, 1, 3328, 3327, 3328, 1, 3328, 3328, 3327, 0, 3327, 1, 1, 2, 0, 3328, 2, 3327, 2, 3328, 3327, 3, 0, 3328, 3328, 3328, 3328, 1, 2, 1, 3328, 0, 3327, 2, 1, 1, 1, 0, 1, 0, 3328, 1, 0, 1, 0, 3327, 1, 3327, 3327, 3328, 1, 3327, 1, 0, 0, 3328, 3327, 3327, 3328, 0, 1, 2, 1, 1, 3328, 3327, 1, 3328, 3328, 1, 3327, 3, 3328, 0, 1, 1, 1, 3328, 3, 0, 1, 3328, 1, 3328, 3328, 0, 1, 1, 1, 2, 2, 3328, 1, 3328, 1, 1, 3328, 1, 1, 0, 0, 0, 3328, 3328, 2, 0, 1, 3327, 0, 0, 3327, 2, 0, 0, 3328, 0, 0, 3327, 1, 3328, 3328, 2, 1, 1, 1, 0, 3328, 1, 3, 1, 3327, 3328, 3328, 0, 3327, 3328, 3328, 1, 0, 3328, 0, 3327, 3326, 2, 3328, 0, 0, 3328, 1, 0, 0, 3327, 3328, 1, 0, 1, 3328, 3328, 0, 3328, 0, 3327}
        };

    uint16_t t_IETF[KYBER_K][KYBER_N] = {        
        {1355, 981, 185, 1507, 2870, 1884, 2361, 2760, 1856, 3025, 2521, 3274, 1921, 2098, 3184, 2839, 637, 2915, 1775, 967, 1954, 2599, 770, 1561, 2618, 2615, 2348, 1538, 658, 1093, 445, 2446, 520, 273, 2961, 110, 2631, 3116, 2345, 359, 2861, 1306, 898, 2070, 2156, 476, 2393, 2041, 300, 3052, 1269, 27, 2650, 996, 584, 3287, 2986, 3076, 3266, 3030, 618, 2971, 723, 3023, 657, 2960, 2247, 1639, 32, 1684, 2913, 2077, 2740, 752, 1733, 2844, 2022, 2637, 861, 1007, 1546, 2, 3324, 2566, 2642, 3116, 11, 1592, 808, 1511, 398, 3238, 2417, 6, 1694, 1156, 133, 3037, 914, 1998, 3245, 359, 2037, 3164, 24, 2916, 1054, 929, 2941, 2442, 325, 935, 1286, 1953, 3317, 3042, 2399, 2029, 2088, 2676, 1746, 429, 1670, 2430, 227, 143, 3079, 2953, 729, 3035, 2206, 1571, 477, 249, 2365, 238, 3060, 1144, 2315, 2076, 1624, 2461, 61, 830, 571, 463, 1686, 146, 2946, 605, 2075, 2291, 1670, 266, 1618, 3252, 149, 813, 3182, 1387, 2867, 3282, 2434, 324, 2587, 132, 1524, 1656, 67, 1350, 2457, 2852, 2732, 2867, 1116, 441, 2196, 2171, 993, 2970, 1730, 1830, 2206, 807, 587, 2572, 2744, 795, 1139, 1302, 362, 2406, 1540, 1366, 1923, 2322, 2278, 515, 1612, 1927, 2919, 644, 1802, 2413, 2471, 5, 2273, 1928, 142, 3151, 1885, 1932, 34, 995, 2940, 65, 190, 22, 2136, 312, 2180, 592, 2685, 2758, 673, 3040, 1630, 908, 1928, 1745, 2031, 950, 862, 11, 2983, 848, 3063, 1239, 2785, 2744, 3283, 2684, 2848, 2587, 680, 763, 2152, 1090, 2230, 2955, 1587, 2246, 2654, 612, 1198, 2457},
        {1630, 1612, 2955, 2564, 3160, 1107, 929, 231, 2410, 1508, 1511, 2933, 1548, 2708, 205, 2547, 925, 2050, 3318, 2549, 391, 1534, 1471, 2106, 510, 970, 531, 2057, 2202, 536, 2745, 3080, 85, 1313, 1848, 98, 601, 2835, 1709, 1564, 1902, 653, 2484, 3254, 3294, 207, 1882, 444, 2825, 227, 2797, 2249, 578, 2739, 1559, 1157, 2335, 3195, 2883, 2585, 269, 1218, 3104, 2937, 1122, 2944, 2236, 1675, 2828, 2969, 1989, 3, 70, 1471, 687, 1263, 3282, 2062, 1843, 2724, 2477, 1534, 1903, 1771, 3077, 1467, 1821, 1538, 2923, 907, 2625, 190, 1087, 1419, 1737, 103, 671, 1268, 1578, 3257, 2439, 2748, 1069, 2188, 319, 1100, 3029, 973, 423, 1181, 2958, 2063, 3175, 1891, 2330, 2097, 1487, 2829, 2882, 2631, 2458, 896, 2636, 2994, 1293, 1675, 577, 984, 842, 2124, 2488, 1471, 2958, 2848, 2052, 3015, 86, 1125, 720, 2158, 1139, 1476, 533, 1883, 839, 3281, 2970, 1361, 2577, 586, 2389, 1519, 669, 3195, 1399, 470, 2741, 3106, 719, 338, 808, 2167, 2715, 1103, 383, 2925, 1429, 2653, 2273, 2644, 1033, 86, 119, 3253, 915, 2465, 1803, 1258, 3186, 2237, 444, 3292, 495, 10, 1060, 2326, 553, 586, 2358, 231, 2693, 148, 245, 2686, 2900, 2414, 1485, 1399, 2804, 1483, 1441, 1011, 3113, 264, 1343, 2700, 774, 1129, 1227, 1984, 621, 2751, 1255, 2712, 2500, 961, 181, 1635, 819, 2250, 796, 1403, 1026, 3271, 397, 482, 1251, 1485, 677, 1645, 1799, 1172, 2916, 556, 2466, 2795, 2551, 1493, 1780, 427, 917, 3034, 2298, 2663, 3276, 2708, 3279, 215, 1716, 1168, 420, 1128, 1609, 1100, 2258, 2957}
    }; 

    uint16_t a_hat[KYBER_N] = {0}; 

    uint16_t t[KYBER_K][KYBER_N] = {{0}}; 

    unsigned char md[EVP_MAX_MD_SIZE];   // Vetor para armazenar o resultado de SHAKE128(ρ|i|j)    
  

    // Gera bytes aleatórios para semente
    generateRandomBytes(d, sizeof(d));                  

    // Aplica a função G em d para obter rho e sigma
    G(d, sizeof(d), rho, sigma);

    

    /*
    // Gera os elementos da matriz A^ pertencente a (Zq256)^k*k
    for (int i=0; i < KYBER_K; i++) {             
        unsigned char i_char = (unsigned char)i;        
        for (int j=0; j < KYBER_K; j++) {              
           memset(md, 0, sizeof(md));              // Reseta o vetor md                  
           unsigned char j_char = (unsigned char)j;           
           XOF(rho, i_char, j_char, md);               
           memset(a_hat, 0, sizeof(a_hat));      // Reinicializa a_hat para garantir que seja único em cada iteração
           sampleNTT(md, a_hat);                // Preenche a_hat com os coeficientes NTT                                                        
           for (int k=0; k < KYBER_N; k++) {                         
                // Copia a_hat para a terceira dimensão da matriz A
                A[i][j][k] = a_hat[k];                   
           }          
        }    
    }
    

   // Gera os elementos do vetor s
   for (int i=0; i < KYBER_K; i++)    {                      // generate s ∈ (Zq256)^k              
        PRF(KYBER_ETA1,sigma,N,output);                      
        samplePolyCBD(output, f, KYBER_ETA1);                                                                       
        for (int j=0; j<KYBER_N; j++) {            
            s[i][j] = f[j];                                 // s[i] ∈ Zq256 sampled from CBD PRF takes a parameter η ∈ {2,3}  PRFn1                     
        }
        N = N + 1;
    }

    // Gera os elementos do vetor e
    for (int i=0; i < KYBER_K; i++)    {                      // generate e ∈ (Zq256)^k                                                                 
        for (int j=0; j<KYBER_N; j++) {
            PRF(KYBER_ETA1,sigma,N,output);
            samplePolyCBD(output, f, KYBER_ETA1);
            e[i][j] = f[j];                                 // e[i] ∈ Zq256 sampled from CBD PRF takes a parameter η ∈ {2,3}  PRFn1
            N = N + 1;
        }
    }

    */

    // Transforma "s" e "e" para o domínio NTT
    for (int i=0; i < KYBER_K; i++) {        
        ntt(s[i]);                         // NTT is run k times (once for each coordinate of s)
        ntt(e[i]);                         // NTT is run k times    
    }  

    calculaT_hat(A,s,e,t);          // t = A ◦ s + e   noisy linear system in NTT domain       

    exibeVetorPolinomios(t,"t_hat"); 
    exibeVetorPolinomios(t_IETF,"t_IETF"); 
    verificaCalculoT(t,t_IETF);

    // Geração das CHAVES
    for (int i=0; i < KYBER_K; i++) {         
        // Codifica t[i]                        // ▷ ByteEncode12 is run k times; include seed for Aˆ        
        byteEncode(t[i], chaves.ek + (i * 384), 12);                                              

        // Codifica s[i] para dk              chaves.dk[i] = byteEncode(s[i]);            // ▷ ByteEncode12 is run k times     
        byteEncode(s[i], chaves.dk + (i * 384), 12);
    }

    // Concatena rho ao final de ek - byteEncode(t[i])||rho;   
    memcpy(chaves.ek + (384 * KYBER_K), rho, 32);
    exibeChaves(chaves);

    return chaves; 
      
}

int main() {
    pkeKeyGen();
    
    
}
